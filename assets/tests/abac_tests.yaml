tests:
  - name: relation_through_ttu_with_condition
    stages:
      - model: |
          model
            schema 1.1
          type user

          type folder
            relations
              define viewer: [user]

          type document
            relations
              define parent: [folder with str_cond, folder with xcond]
              define viewer: [user] or viewer from parent

          condition str_cond(s: string) {
            s == "hello"
          }

          condition xcond(x: int) {
            x == 10
          }
        tuples:
          - user: folder:a
            relation: parent
            object: document:1
            condition:
              name: str_cond
          - user: folder:b
            relation: parent
            object: document:1
            condition:
              name: xcond
          - user: user:jon
            relation: viewer
            object: folder:a
          - user: user:jon
            relation: viewer
            object: folder:b
        checkAssertions:
#          - tuple:
#              user: user:jon
#              relation: viewer
#              object: document:1
#            errorCode: 2000
#          - tuple:
#              user: user:jon
#              relation: viewer
#              object: document:1
#            context:
#              "s": "hello"
#            expectation: true
#          - tuple:
#              user: user:jon
#              relation: viewer
#              object: document:1
#            context:
#              "x": 10
#            expectation: true
          - tuple:
              user: user:jon
              relation: viewer
              object: document:1
            context:
              "s": "foo"
            errorCode: 2000
          - tuple:
              user: user:jon
              relation: viewer
              object: document:1
            context:
              "x": 15
            errorCode: 2000
          - tuple:
              user: user:jon
              relation: viewer
              object: document:1
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:jon
            expectation: true
        listUsersAssertions:
          - request:
              filters:
                - user
              object: document:1
              relation: viewer
            errorCode: 2000
          - request:
              filters:
                - user
              object: document:1
              relation: viewer
            context:
              "s": "hello"
            errorCode: 2000
          - request:
              filters:
                - user
              object: document:1
              relation: viewer
            context:
              "x": 10
            errorCode: 2000
          - request:
              filters:
                - user
              object: document:1
              relation: viewer
            context:
              "s": "not hello"
            errorCode: 2000
          - request:
              filters:
                - user
              object: document:1
              relation: viewer
            context:
              "x": 11
            errorCode: 2000
          - request:
              filters:
                - folder#viewer
              object: document:1
              relation: viewer
            context:
              "x": 10
            errorCode: 2000
          - request:
              filters:
                - folder#viewer
              object: document:1
              relation: viewer
            context:
              "s": "hello"
            errorCode: 2000
          - request:
              filters:
                - folder#viewer
              object: document:1
              relation: viewer
            context:
              "s": "hello"
              "x": 10
            expectation:
              - folder:a#viewer
              - folder:b#viewer
          - request:
              filters:
                - folder#viewer
              object: document:1
              relation: viewer
            context:
              "s": "not hello"
              "x": 11
            expectation:
  